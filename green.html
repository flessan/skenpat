<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bersihkan Hutan Sekolah – Green Generation</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Quicksand', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #2d3436;
      padding: 1rem;
      transition: background 1s ease;
      overflow-x: hidden;
    }

    /* Time-based backgrounds */
    body.morning {
      background: linear-gradient(to bottom, #a2d9ff 0%, #a2d9ff 40%, #b8e6a3 40%, #98d98e 100%);
    }
    body.afternoon {
      background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 40%, #98D98E 40%, #8bc34a 100%);
    }
    body.evening {
      background: linear-gradient(to bottom, #ffcc80 0%, #ffcc80 40%, #a5d6a7 40%, #689f38 100%);
    }
    body.night {
      background: linear-gradient(to bottom, #1a237e 0%, #1a237e 40%, #2e7d32 40%, #1b5e20 100%);
      color: #e0f7fa;
    }

    body.cleaned.morning,
    body.cleaned.afternoon,
    body.cleaned.evening {
      background: linear-gradient(to bottom, #a2d9ff 0%, #a2d9ff 40%, #4CAF50 40%, #2e7d32 100%);
    }
    body.cleaned.night {
      background: linear-gradient(to bottom, #1a237e 0%, #1a237e 40%, #388e3c 40%, #1b5e20 100%);
    }

    header {
      width: 100%;
      text-align: center;
    }

    h1 {
      font-size: clamp(1.4rem, 5vw, 2rem);
      margin: 1rem 0;
      color: #1e5631;
      background: rgba(255, 255, 255, 0.85);
      padding: 0.6rem 1rem;
      border-radius: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      display: inline-block;
    }

    body.night h1 {
      background: rgba(30, 30, 40, 0.85);
      color: #bbdefb;
    }

    main {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-grow: 1;
    }

    #game-area {
      position: relative;
      width: min(95vw, 400px);
      height: clamp(280px, 55vh, 400px);
      background: rgba(255, 255, 255, 0.6);
      border-radius: 16px;
      margin: 1rem 0;
      overflow: hidden;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    body.night #game-area {
      background: rgba(20, 25, 40, 0.7);
    }

    #trash-bin {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: clamp(40px, 7vw, 62px);
      color: #555;
      transition: transform 0.2s, color 0.2s;
      z-index: 5;
    }

    body.night #trash-bin {
      color: #e0f7fa;
    }

    #trash-bin.highlight {
      transform: translateX(-50%) scale(1.1);
      color: #2c7a0b;
    }

    .item {
      position: absolute;
      font-size: clamp(36px, 6vw, 36px);
      cursor: grab;
      user-select: none;
      z-index: 2;
      transition: transform 0.2s;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    .item.dragging {
      cursor: grabbing;
      transform: scale(1.15);
      z-index: 10;
    }

    .status-container {
      margin: 0.8rem 0;
      font-weight: 600;
      background: rgba(255,255,255,0.85);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      text-align: center;
      width: min(80vw, 300px);
    }

    body.night .status-container {
      background: rgba(30, 35, 50, 0.85);
      color: #bbdefb;
    }

    #complete-container {
      display: none;
      flex-direction: column;
      align-items: center;
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      max-width: min(90vw, 350px);
      animation: fadeIn 0.5s ease;
    }

    body.night #complete-container {
      background: rgba(30, 35, 50, 0.9);
      color: #e0f7fa;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #countdown {
      font-size: clamp(1.2rem, 4vw, 1.4rem);
      margin: 0.5rem 0;
      font-weight: bold;
    }

    .btn {
      padding: 0.5rem 1rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      font-size: clamp(0.9rem, 3vw, 1rem);
      transition: background 0.2s;
    }

    .btn:hover {
      background: #388E3C;
    }

    footer {
      margin-top: auto;
      padding: 0.5rem;
      text-align: center;
      font-size: clamp(0.7rem, 2.5vw, 0.9rem);
      font-style: italic;
      color: #1e5631;
      opacity: 0.85;
      width: 100%;
    }

    body.night footer {
      color: #bbdefb;
      opacity: 0.9;
    }

    #loading-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
    }

    body.night #loading-overlay {
      background: rgba(15, 20, 35, 0.95);
      color: #e0f7fa;
    }

    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    body.night .spinner {
      border-color: #4a4a6a;
      border-top-color: #66bb6a;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Added error message styling */
    .error-message {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #f44336;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1001;
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-seedling"></i> Bersihkan Hutan Sekolah! <i class="fas fa-leaf"></i></h1>
  </header>

  <main>
    <div id="game-area" role="application" aria-label="Area permainan bersih-bersih hutan">
      <div id="trash-bin" role="button" aria-label="Tempat sampah"><i class="fas fa-trash-alt"></i></div>
    </div>

    <div class="status-container">
      <div id="status" aria-live="polite">Sisa sampah: 3</div>
    </div>

    <div id="complete-container">
      <div><i class="fas fa-check-circle"></i> Hutan Sekolah Bersih! <i class="fas fa-tree"></i></div>
      <div id="countdown" aria-live="polite">5</div>
      <button id="cancel-redirect" class="btn">Ulangi Aksi!</button>
    </div>
  </main>

  <footer class="environment-quote">
    "Menjadi pelopor pelestarian lingkungan di sekolah — Green Generation SMKN 4 Banjarmasin"
  </footer>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div>Mengarahkan ke green.wasmer.app...</div>
  </div>

  <div id="error-message" class="error-message"></div>

  <script>
  // === Error Handling ===
  window.addEventListener('error', (e) => {
    if (e.target.tagName === 'LINK') {
      showError("Gagal memuat sumber daya eksternal. Beberapa tampilan mungkin tidak berfungsi dengan baik.");
    }
  }, true);

  function showError(message) {
    const errorEl = document.getElementById('error-message');
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => errorEl.style.display = 'none', 5000);
    }
  }

  // === Time-of-Day Background ===
  function setTimeOfDayClass() {
    const hour = new Date().getHours();
    let timeClass = 'afternoon';
    if (hour >= 5 && hour < 10) timeClass = 'morning';
    else if (hour >= 10 && hour < 16) timeClass = 'afternoon';
    else if (hour >= 16 && hour < 18.5) timeClass = 'evening';
    else timeClass = 'night';

    document.body.className = document.body.className
      .replace(/\b(morning|afternoon|evening|night)\b/g, '')
      .trim();
    document.body.classList.add(timeClass);
  }

  // === Game State ===
  const gameState = {
    itemsLeft: 0,
    isRedirecting: false,
    redirectTimer: null,
    draggedItem: null,
    isDragging: false,
    totalItems: 0
  };

  const elements = {
    gameArea: null,
    statusText: null,
    completeContainer: null,
    countdownEl: null,
    cancelBtn: null,
    trashBin: null,
    loadingOverlay: null,
    quote: null
  };

  // === Konfigurasi Sampah (sesuai program GG) ===
  const config = {
    icons: [
      "<i class='fas fa-bottle-water' aria-label='Botol plastik'></i>",
      "<i class='fas fa-can' aria-label='Kaleng minuman'></i>",
      "<i class='fas fa-soap' aria-label='Sabun dari minyak jelantah'></i>",
      "<i class='fas fa-leaf' aria-label='Sampah organik'></i>",
      "<i class='fas fa-box-open' aria-label='Kardus bekas'></i>",
      "<i class='fas fa-wine-bottle' aria-label='Botol kaca'></i>",
      "<i class='fas fa-prescription-bottle' aria-label='Botol plastik kecil'></i>",
      "<i class='fas fa-cookie' aria-label='Bungkus makanan'></i>"
    ],
    initialItemCount: 8, // ✅ Lebih banyak dari target awal (3 → 8)
    redirectCountdown: 4,
    safeZoneTop: 5,
    safeZoneBottom: 65,
    safeZoneLeft: 5,
    safeZoneRight: 90
  };

  // === Inisialisasi Elemen DOM ===
  function initElements() {
    elements.gameArea = document.getElementById("game-area");
    elements.statusText = document.getElementById("status");
    elements.completeContainer = document.getElementById("complete-container");
    elements.countdownEl = document.getElementById("countdown");
    elements.cancelBtn = document.getElementById("cancel-redirect");
    elements.trashBin = document.getElementById("trash-bin");
    elements.loadingOverlay = document.getElementById("loading-overlay");
    elements.quote = document.querySelector('.environment-quote');

    // Validasi elemen penting
    if (!elements.gameArea || !elements.trashBin) {
      showError("Elemen permainan tidak ditemukan. Pastikan struktur HTML lengkap.");
      return false;
    }
    return true;
  }

  // === Init Game ===
  function initGame() {
    try {
      if (!initElements()) return;
      setTimeOfDayClass();
      resetGameState();
      spawnItems();
      setupEventListeners();
    } catch (error) {
      console.error("Error initializing game:", error);
      showError("Terjadi kesalahan saat memulai permainan. Silakan muat ulang halaman.");
    }
  }

  function resetGameState() {
    gameState.itemsLeft = config.initialItemCount;
    gameState.totalItems = config.initialItemCount;
    gameState.isRedirecting = false;
    gameState.draggedItem = null;
    gameState.isDragging = false;
  }

  function spawnItems() {
    // Hapus item lama
    document.querySelectorAll('#game-area .item').forEach(el => el.remove());

    // Spawn item baru
    for (let i = 0; i < gameState.totalItems; i++) {
      const item = createTrashItem();
      elements.gameArea.insertBefore(item, elements.trashBin);
    }

    updateStatusText();
  }

  function updateStatusText() {
    if (elements.statusText) {
      elements.statusText.textContent = `Sisa sampah: ${gameState.itemsLeft}`;
    }
  }

  function createTrashItem() {
    const item = document.createElement("div");
    item.className = "item";
    item.setAttribute("role", "button");
    item.setAttribute("aria-label", "Sampah yang bisa dibuang");
    item.innerHTML = config.icons[Math.floor(Math.random() * config.icons.length)];

    // ✅ Perbaiki: definisikan safeLeft & safeTop
    const safeTop = Math.random() * (config.safeZoneBottom - config.safeZoneTop) + config.safeZoneTop;
    const safeLeft = Math.random() * (config.safeZoneRight - config.safeZoneLeft) + config.safeZoneLeft;

    item.style.left = `${safeLeft}%`;
    item.style.top = `${safeTop}%`;

    return item;
  }

  function setupEventListeners() {
    // Mouse
    elements.gameArea.addEventListener("mousedown", handleStartDrag);
    document.addEventListener("mousemove", handleMoveDrag);
    document.addEventListener("mouseup", handleEndDrag);

    // Touch
    elements.gameArea.addEventListener("touchstart", handleStartDrag, { passive: false });
    document.addEventListener("touchmove", handleMoveDrag, { passive: false });
    document.addEventListener("touchend", handleEndDrag);

    // Tombol
    if (elements.cancelBtn) {
      elements.cancelBtn.addEventListener("click", cancelRedirect);
    }

    // Cegah scroll saat drag di perangkat sentuh
    elements.gameArea.addEventListener("touchmove", (e) => {
      if (gameState.isDragging) e.preventDefault();
    }, { passive: false });
  }

  function handleStartDrag(e) {
    const target = e.target.closest('.item');
    if (!target) return;

    e.preventDefault();
    gameState.draggedItem = target;
    gameState.isDragging = true;
    target.classList.add("dragging");

    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const rect = target.getBoundingClientRect();

    gameState.offsetX = clientX - rect.left;
    gameState.offsetY = clientY - rect.top;
  }

  function handleMoveDrag(e) {
    if (!gameState.isDragging || !gameState.draggedItem) return;
    e.preventDefault();

    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const areaRect = elements.gameArea.getBoundingClientRect();

    let x = clientX - areaRect.left - gameState.offsetX;
    let y = clientY - areaRect.top - gameState.offsetY;

    // Batasi dalam area
    x = Math.max(0, Math.min(x, areaRect.width - gameState.draggedItem.offsetWidth));
    y = Math.max(0, Math.min(y, areaRect.height - gameState.draggedItem.offsetHeight));

    gameState.draggedItem.style.left = `${x}px`;
    gameState.draggedItem.style.top = `${y}px`;

    checkTrashBinProximity(clientX, clientY);
  }

  function checkTrashBinProximity(clientX, clientY) {
    const binRect = elements.trashBin.getBoundingClientRect();
    const isNear = (
      clientX > binRect.left - 30 &&
      clientX < binRect.right + 30 &&
      clientY > binRect.top - 30 &&
      clientY < binRect.bottom + 30
    );
    elements.trashBin.classList.toggle("highlight", isNear);
  }

  function handleEndDrag() {
    if (!gameState.isDragging || !gameState.draggedItem) return;

    gameState.isDragging = false;
    elements.trashBin.classList.remove("highlight");

    const item = gameState.draggedItem;
    item.classList.remove("dragging");

    if (isItemInTrashBin(item)) {
      handleTrashCollected(item);
    }

    gameState.draggedItem = null;
  }

  function isItemInTrashBin(item) {
    const itemRect = item.getBoundingClientRect();
    const binRect = elements.trashBin.getBoundingClientRect();

    const itemCenterX = itemRect.left + itemRect.width / 2;
    const itemCenterY = itemRect.top + itemRect.height / 2;

    return (
      itemCenterX >= binRect.left &&
      itemCenterX <= binRect.right &&
      itemCenterY >= binRect.top &&
      itemCenterY <= binRect.bottom
    );
  }

  function handleTrashCollected(item) {
    createParticleEffect(item);
    item.remove();
    gameState.itemsLeft--;
    updateStatusText();

    if (gameState.itemsLeft === 0) {
      completeGame();
    }
  }

  function createParticleEffect(item) {
    const rect = item.getBoundingClientRect();
    const gameRect = elements.gameArea.getBoundingClientRect();

    for (let i = 0; i < 6; i++) {
      const particle = document.createElement("div");
      particle.innerHTML = "<i class='fas fa-star' style='color: #4CAF50;' aria-hidden='true'></i>";
      particle.style.cssText = `
        position: absolute;
        left: ${rect.left - gameRect.left + rect.width / 2}px;
        top: ${rect.top - gameRect.top + rect.height / 2}px;
        pointer-events: none;
        opacity: 0;
        z-index: 100;
        font-size: 16px;
        transition: transform 0.7s, opacity 0.7s;
      `;
      particle.setAttribute("aria-hidden", "true");
      elements.gameArea.appendChild(particle);

      setTimeout(() => {
        const angle = (i / 6) * Math.PI * 2;
        const distance = 30 + Math.random() * 20;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance - 40;
        particle.style.transform = `translate(${tx}px, ${ty}px) scale(0.8)`;
        particle.style.opacity = "1";
      }, 10);

      setTimeout(() => particle.remove(), 700);
    }
  }

  function completeGame() {
    document.body.classList.add("cleaned");
    if (elements.completeContainer) elements.completeContainer.style.display = "flex";
    if (elements.quote) {
      elements.quote.textContent = '"Terima kasih! Kamu telah berkontribusi untuk lingkungan sekolah yang sehat dan hijau."';
    }
    startRedirect();
  }

  function startRedirect() {
    let seconds = config.redirectCountdown;
    if (elements.countdownEl) elements.countdownEl.textContent = seconds;

    gameState.redirectTimer = setInterval(() => {
      seconds--;
      if (elements.countdownEl) elements.countdownEl.textContent = seconds;
      if (seconds <= 0) {
        clearInterval(gameState.redirectTimer);
        redirectToGreen();
      }
    }, 1000);
  }

  function redirectToGreen() {
    if (gameState.isRedirecting) return;
    gameState.isRedirecting = true;
    if (elements.loadingOverlay) elements.loadingOverlay.style.display = "flex";
    setTimeout(() => {
      window.location.href = "https://green.wasmer.app/";
    }, 1200);
  }

  function cancelRedirect() {
    if (gameState.redirectTimer) clearInterval(gameState.redirectTimer);
    if (elements.completeContainer) elements.completeContainer.style.display = "none";

    resetGameState();
    document.body.classList.remove("cleaned");
    if (elements.quote) {
      elements.quote.textContent = '"Menjadi pelopor pelestarian lingkungan di sekolah — Green Generation SMKN 4 Banjarmasin"';
    }

    setTimeout(spawnItems, 300);
  }

  // Jalankan saat DOM siap
  document.addEventListener("DOMContentLoaded", initGame);
</script>
</body>
</html>


